<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Vandaag - Magister</title>
    <link rel="icon" href="https://i.postimg.cc/vZjtzb5T/Magister-6-logo.jpg" type="image/jpeg" />
  <style>
    /* Basis styling */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      margin: 0;
      padding: 30px;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    #container {
      background: #fff;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      padding: 25px 30px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    h2, h3, h4 {
      margin-top: 0;
      color: #444;
    }

    input, button {
      font-size: 1rem;
      border-radius: 6px;
      border: 1.5px solid #ccc;
      padding: 12px 15px;
      margin-top: 12px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #2575fc;
      box-shadow: 0 0 8px rgba(37, 117, 252, 0.5);
    }
    button {
      background: #2575fc;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    button:hover:not(:disabled) {
      background: #1a52d8;
    }
    button:disabled {
      background: #a0b8f7;
      cursor: not-allowed;
    }

    #chat-box {
      border: 1.5px solid #ddd;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      background-color: #f9f9fb;
      margin: 15px 0;
      border-radius: 10px;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .message {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
    }
    .message .email {
      font-weight: 700;
      color: #2575fc;
      margin-right: 8px;
    }
    .message .text {
      flex: 1;
      white-space: pre-wrap;
      word-break: break-word;
      color: #333;
    }

    #currentGroup {
      margin: 15px 0 10px 0;
      font-weight: 600;
      font-size: 1.1rem;
      color: #444;
    }

    /* Flexbox voor knoppen naast elkaar */
    .inline-inputs {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    .inline-inputs input {
      flex: 1;
      margin-top: 0;
    }
    .inline-inputs button {
      flex-shrink: 0;
      width: 140px;
      margin-top: 0;
    }

    /* Welkomsttekst */
    #chat-section h3 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0;
    }
    #chat-section h3 span {
      color: #2575fc;
      font-weight: 700;
    }

  </style>
</head>
<body>

<div id="container">

  <!-- 🔐 Auth -->
  <div id="auth-section">
    <h2>Login of Registreer</h2>
    <input id="email" type="email" placeholder="E-mail" autocomplete="username" />
    <input id="password" type="password" placeholder="Wachtwoord" autocomplete="current-password" />
    <button id="registerBtn" onclick="register()">Registreer</button>
    <button id="loginBtn" onclick="login()">Login</button>
  </div>

  <!-- 💬 Chat -->
  <div id="chat-section" style="display:none;">
    <h3>Welkom, <span id="userEmail"></span> <button onclick="logout()" style="background:#e14c4c; padding:5px 12px; font-weight:600; border-radius:6px; border:none; cursor:pointer;">Uitloggen</button></h3>

    <hr style="margin: 15px 0;">

    <h4>Maak een groep of join via code</h4>

    <div class="inline-inputs">
      <input id="groupName" placeholder="Nieuwe groepsnaam" />
      <button onclick="createGroup()">Maak Groep</button>
    </div>

    <div class="inline-inputs" style="margin-top: 10px;">
      <input id="groupCodeInput" placeholder="Groep-ID plakken" />
      <button onclick="joinGroup()">Ga naar Groep</button>
    </div>

    <div id="currentGroup"></div>

    <div id="chat-box" aria-live="polite" aria-label="Chat berichten"></div>

    <div class="inline-inputs">
      <input id="messageInput" placeholder="Typ een bericht..." autocomplete="off" />
      <button id="sendBtn" onclick="sendMessage()" disabled>Verstuur</button>
    </div>
  </div>

</div>

<!-- 🔥 Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import {
    getFirestore,
    addDoc,
    collection,
    query,
    orderBy,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBRyDFtkGAMxkTSvIF-GQ0tNFrVv2mC05M",
    authDomain: "chatsite-7473e.firebaseapp.com",
    projectId: "chatsite-7473e",
    storageBucket: "chatsite-7473e.firebasestorage.app",
    messagingSenderId: "518173129704",
    appId: "1:518173129704:web:e619ace7c4b6e13086c25d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentGroupId = null;
  let unsubscribeMessages = null;

  // Elementen
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const authSection = document.getElementById("auth-section");
  const chatSection = document.getElementById("chat-section");
  const userEmail = document.getElementById("userEmail");
  const chatBox = document.getElementById("chat-box");
  const messageInput = document.getElementById("messageInput");
  const groupName = document.getElementById("groupName");
  const groupCodeInput = document.getElementById("groupCodeInput");
  const currentGroup = document.getElementById("currentGroup");
  const sendBtn = document.getElementById("sendBtn");

  // Registreer functie
  window.register = () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) {
      alert("Vul zowel e-mail als wachtwoord in.");
      return;
    }
    createUserWithEmailAndPassword(auth, email, password)
      .then(() => {
        alert("Geregistreerd!");
        emailInput.value = "";
        passwordInput.value = "";
      })
      .catch(err => alert("Registratie fout: " + err.message));
  };

  // Login functie
  window.login = () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) {
      alert("Vul zowel e-mail als wachtwoord in.");
      return;
    }
    signInWithEmailAndPassword(auth, email, password)
      .catch(err => alert("Login fout: " + err.message));
  };

  // Logout functie
  window.logout = () => {
    if (unsubscribeMessages) {
      unsubscribeMessages();
      unsubscribeMessages = null;
    }
    signOut(auth);
    currentGroupId = null;
    currentGroup.textContent = "";
    chatBox.innerHTML = "";
  };

  // Auth state observer
  onAuthStateChanged(auth, (user) => {
    if (user) {
      authSection.style.display = "none";
      chatSection.style.display = "block";
      userEmail.textContent = user.email;
    } else {
      authSection.style.display = "block";
      chatSection.style.display = "none";
      userEmail.textContent = "";
    }
  });

  // Groep aanmaken
  window.createGroup = async () => {
    const name = groupName.value.trim();
    if (!name) {
      alert("Geef een groepsnaam op.");
      return;
    }
    try {
      const groupRef = await addDoc(collection(db, "groups"), {
        name,
        createdAt: Date.now()
      });
      alert("Groep aangemaakt. Code: " + groupRef.id);
      groupName.value = "";
      loadGroup(groupRef.id);
    } catch (err) {
      alert("Fout bij aanmaken groep: " + err.message);
    }
  };

  // Groep joinen via ID
  window.joinGroup = () => {
    const id = groupCodeInput.value.trim();
    if (!id) {
      alert("Plak een groep-ID.");
      return;
    }
    loadGroup(id);
    groupCodeInput.value = "";
  };

  // Chat laden en live updates ontvangen
  function loadGroup(groupId) {
    if (unsubscribeMessages) {
      unsubscribeMessages();
      unsubscribeMessages = null;
    }
    currentGroupId = groupId;
    currentGroup.textContent = "In groep: " + groupId;

    const messagesRef = collection(db, "groups", groupId, "messages");
    const q = query(messagesRef, orderBy("timestamp"));

    unsubscribeMessages = onSnapshot(q, snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        const msg = doc.data();
        const msgDiv = document.createElement("div");
        msgDiv.className = "message";
        msgDiv.innerHTML = `<span class="email">${escapeHTML(msg.user)}</span><span class="text">: ${escapeHTML(msg.text)}</span>`;
        chatBox.appendChild(msgDiv);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
      messageInput.focus();
      checkMessageInput();
    }, err => {
      alert("Fout bij laden berichten: " + err.message);
    });
  }

  // Bericht versturen
  window.sendMessage = async () => {
    const text = messageInput.value.trim();
    const user = auth.currentUser;
    if (!text || !currentGroupId || !user) return;
    try {
      await addDoc(collection(db, "groups", currentGroupId, "messages"), {
        text,
        user: user.email,
        timestamp: Date.now()
      });
      messageInput.value = "";
      sendBtn.disabled = true;
    } catch (err) {
      alert("Fout bij verzenden bericht: " + err.message);
    }
  };

  // Veiligheid: escape HTML
  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, tag => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[tag]));
  }

  // Enter-to-send functie voor berichtinput
  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey && !sendBtn.disabled) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Enable/disable send button op basis van input
  messageInput.addEventListener("input", checkMessageInput);
  function checkMessageInput() {
    sendBtn.disabled = !messageInput.value.trim();
  }
</script>

</body>
</html>
